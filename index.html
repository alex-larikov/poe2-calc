<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoE 2: Fate of the Vaal Optimizer</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #0c0c0c; color: #d1d1d1; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: #161616; padding: 25px; border-radius: 12px; width: 100%; max-width: 380px; border: 1px solid #2a2a2a; box-shadow: 0 8px 32px rgba(0,0,0,0.6); margin-bottom: 20px; }
        h2 { color: #e1ad5f; text-align: center; margin: 0 0 20px 0; font-size: 1.1rem; text-transform: uppercase; }
        .btn-sync { width: 100%; padding: 14px; background: #e1ad5f; border: none; border-radius: 6px; color: #000; font-weight: 800; cursor: pointer; margin-bottom: 15px; text-transform: uppercase; }
        label { display: block; font-size: 0.7rem; color: #888; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 12px; background: #222; border: 1px solid #333; color: #fff; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; }
        .result { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; display: none; border: 1px solid transparent; }
        .better { background: rgba(45, 106, 79, 0.2); border-color: #2d6a4f; color: #95d5b2; }
        .worse { background: rgba(106, 45, 45, 0.2); border-color: #6a2d2d; color: #d59595; }
        
        /* Debug Console Styles */
        .debug-panel { width: 100%; max-width: 380px; background: #000; border: 1px solid #444; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 0.7rem; color: #0f0; }
        .debug-url { color: #555; word-break: break-all; margin-bottom: 10px; display: block; }
        .debug-log { max-height: 200px; overflow-y: auto; white-space: pre-wrap; color: #aaa; }
    </style>
</head>
<body>

<div class="card">
    <h2>Vaal Exchange Calc</h2>
    <button class="btn-sync" onclick="fetchRates()">Sync Market Rates</button>
    
    <label>1 Divine = ? Exalts</label>
    <input type="number" id="divExRate" step="0.01" oninput="calculate()">

    <hr style="border:0; border-top: 1px solid #2a2a2a; margin: 20px 0;">

    <label>Item Price (Divines)</label>
    <input type="number" id="pDiv" oninput="calculate()">

    <label>Item Price (Exalts)</label>
    <input type="number" id="pEx" oninput="calculate()">

    <div id="result" class="result"></div>
</div>

<div class="debug-panel">
    <strong>DEBUG CONSOLE</strong>
    <span id="debug-url" class="debug-url">URL: Waiting...</span>
    <div id="debug-log" class="debug-log">Log: App started. Click Sync.</div>
</div>

<script>
async function fetchRates() {
    const log = document.getElementById('debug-log');
    const urlDisplay = document.getElementById('debug-url');
    log.innerText = "Attempting fetch...";

    const league = "Fate+of+the+Vaal";
    const proxy = "https://corsproxy.io/?";
    const target = `https://poe.ninja/poe2/api/economy/exchange/current/overview?league=${league}&type=Currency`;
    
    urlDisplay.innerText = "URL: " + target;

    try {
        const response = await fetch(proxy + encodeURIComponent(target));
        const data = await response.json();
        
        log.innerText = "Data received. Parsing items...\n";

        // Find items by checking various possible key names
        const findOrb = (name) => data.lines.find(i => 
            (i.currencyTypeName && i.currencyTypeName.includes(name)) || 
            (i.detailsId && i.detailsId.includes(name.toLowerCase().replace(' ', '-')))
        );

        const div = findOrb('Divine');
        const ex = findOrb('Exalted');

        if (div && ex) {
            const rate = (div.chaosEquivalent / ex.chaosEquivalent).toFixed(2);
            document.getElementById('divExRate').value = rate;
            log.innerText += `SUCCESS!\nDivine Chaos: ${div.chaosEquivalent}\nExalt Chaos: ${ex.chaosEquivalent}\nRatio: ${rate}`;
            calculate();
        } else {
            log.innerText += "ERROR: Could not find orbs in data.\nAvailable items: " + 
                data.lines.slice(0, 5).map(i => i.currencyTypeName || i.detailsId).join(', ') + "...";
        }
    } catch (e) {
        log.innerText += "FETCH FAILED: " + e.message;
    }
}

function calculate() {
    const rate = parseFloat(document.getElementById('divExRate').value);
    const pDiv = parseFloat(document.getElementById('pDiv').value);
    const pEx = parseFloat(document.getElementById('pEx').value);
    const res = document.getElementById('result');

    if (!rate || !pDiv || !pEx) { res.style.display = 'none'; return; }

    res.style.display = 'block';
    const costIfConverted = pDiv * rate;
    const diff = Math.abs(pEx - costIfConverted).toFixed(1);
    
    if (costIfConverted < pEx) {
        res.className = 'result better';
        res.innerHTML = `CONVERT TO EXALTS<br><small>Saves you ~${diff} Exalts.</small>`;
    } else {
        res.className = 'result worse';
        res.innerHTML = `PAY DIVINES DIRECTLY<br><small>Saves you ~${diff} Exalts equivalent.</small>`;
    }
}

window.onload = fetchRates;
</script>

</body>
</html>
