<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoE 2 Smart Calc</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #e0e0e0; padding: 20px; display: flex; justify-content: center; }
        .card { background: #1e1e1e; padding: 25px; border-radius: 12px; width: 100%; max-width: 420px; border: 1px solid #333; }
        h2 { color: #e1ad5f; text-align: center; margin: 0 0 20px 0; font-size: 1.5rem; }
        .btn-fetch { width: 100%; padding: 12px; background: #e1ad5f; border: none; border-radius: 6px; color: #121212; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .btn-fetch:hover { background: #ffcc7a; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; color: #aaa; margin-bottom: 5px; text-transform: uppercase; }
        input { width: 100%; padding: 12px; background: #262626; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .result { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; border: 1px solid transparent; }
        .better { background: #1b4332; color: #95d5b2; border-color: #2d6a4f; }
        .worse { background: #431b1b; color: #d59595; border-color: #6a2d2d; }
        .status { font-size: 0.7rem; text-align: center; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>PoE 2 Exchange Helper</h2>
    
    <button class="btn-fetch" onclick="fetchRates()">Update Market Rates</button>
    <div id="status" class="status">Rates: Manual Entry</div>

    <div class="input-group">
        <label>1 Divine = ? Exalts</label>
        <input type="number" id="divExRate" placeholder="Fetch or enter..." oninput="calculate()">
    </div>

    <hr style="border:0; border-top: 1px solid #333; margin: 20px 0;">

    <div class="input-group">
        <label>Item Price (Divines)</label>
        <input type="number" id="priceDiv" placeholder="e.g. 5" oninput="calculate()">
    </div>
    <div class="input-group">
        <label>Item Price (Exalts)</label>
        <input type="number" id="priceEx" placeholder="e.g. 240" oninput="calculate()">
    </div>

    <div id="result" class="result" style="display:none;"></div>
</div>

<script>
async function fetchRates() {
    const status = document.getElementById('status');
    status.innerText = "Fetching from poe.ninja...";
    
    // We use a public CORS proxy to access the poe.ninja API
    const proxy = "https://corsproxy.io/?";
    const url = encodeURIComponent("https://poe.ninja/api/data/currencyoverview?league=PoE2%20Standard&type=Currency");

    try {
        const response = await fetch(proxy + url);
        const data = await response.json();
        
        // Logic to find Divine and Exalt values relative to Chaos
        const divineData = data.lines.find(i => i.currencyTypeName === 'Divine Orb');
        const exaltData = data.lines.find(i => i.currencyTypeName === 'Exalted Orb');

        if (divineData && exaltData) {
            const rate = (divineData.chaosEquivalent / exaltData.chaosEquivalent).toFixed(2);
            document.getElementById('divExRate').value = rate;
            status.innerText = `Auto-Updated: 1 Div = ${rate} Ex`;
            calculate();
        }
    } catch (e) {
        status.innerText = "Error fetching rates. Enter manually.";
        console.error(e);
    }
}

function calculate() {
    const divEx = parseFloat(document.getElementById('divExRate').value);
    const pDiv = parseFloat(document.getElementById('priceDiv').value);
    const pEx = parseFloat(document.getElementById('priceEx').value);

    if (!divEx || !pDiv || !pEx) return;

    const resultDiv = document.getElementById('result');
    resultDiv.style.display = 'block';

    const costInExIfConverted = pDiv * divEx;
    
    if (costInExIfConverted < pEx) {
        const saved = (pEx - costInExIfConverted).toFixed(1);
        resultDiv.className = 'result better';
        resultDiv.innerHTML = `CONVERT TO EXALTS<br><small>Saves ~${saved} Exalts</small>`;
    } else {
        const saved = (costInExIfConverted - pEx).toFixed(1);
        resultDiv.className = 'result worse';
        resultDiv.innerHTML = `BUY DIRECTLY (DIV)<br><small>Saves ~${saved} Exalts equivalent</small>`;
    }
}
</script>

</body>
</html>
