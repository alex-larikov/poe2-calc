<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaal Arbitrage & Table</title>
    <style>
        :root { --gold: #e1ad5f; --bg: #0c0c0c; --card: #161616; --border: #2a2a2a; --green: #95d5b2; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #d1d1d1; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 700px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        h2 { color: var(--gold); text-align: center; margin-top: 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Dashboard Styles */
        .rates-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .rate-box { background: #222; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #333; }
        .rate-box small { display: block; color: #888; font-size: 0.7rem; }
        
        /* Optimal Tags */
        .optimal-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-left: 10px; }
        .tag-div { background: #4a3a1a; color: #ffcc66; }
        .tag-ex { background: #1a2e4a; color: #66ccff; }
        .tag-ch { background: #2d4a1a; color: #95d5b2; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 10px; }
        th { text-align: left; color: #666; padding: 8px; border-bottom: 2px solid #333; }
        td { padding: 8px; border-bottom: 1px solid #222; }
        .val-col { font-family: monospace; text-align: right; }
        .highlight { color: var(--green); font-weight: bold; }
        .strike { text-decoration: line-through; opacity: 0.5; font-size: 0.75rem; }

        .btn-sync { width: 100%; padding: 12px; background: var(--gold); border: none; border-radius: 6px; color: #000; font-weight: 800; cursor: pointer; margin-bottom: 10px; }
        .status { font-size: 0.65rem; text-align: center; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-sync" onclick="fetchRates()">SYNC LIVE MARKET DATA</button>
    <div id="status" class="status">Waiting for user sync...</div>

    <div class="card">
        <h2>Live Benchmarks</h2>
        <div class="rates-grid">
            <div class="rate-box"><small>1 DIV : ? EX</small><span id="rate-div-ex">---</span></div>
            <div class="rate-box"><small>1 DIV : ? CHAOS</small><span id="rate-div-ch">---</span></div>
        </div>
    </div>

    <div class="card">
        <h2>Price Comparison (Value in Exalts)</h2>
        <table id="details-table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th class="val-col">Via Div</th>
                    <th class="val-col">Via Chaos</th>
                    <th class="val-col">Via Ex</th>
                    <th class="val-col">Best Path</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</div>

<script>
// Correct IDs from your JSON
const targetItems = ["perfect-exalted-orb", "perfect-orb-of-augmentation", "scrap"];
let rates = { d2e: 0, d2c: 0, c2e: 0 };

async function fetchRates() {
    const status = document.getElementById('status');
    const proxy = "https://corsproxy.io/?";
    const target = "https://poe.ninja/poe2/api/economy/exchange/current/overview?league=Fate+of+the+Vaal&type=Currency";
    
    try {
        const response = await fetch(proxy + encodeURIComponent(target));
        const data = await response.json();
        
        // 1. Setup Benchmarks
        const exLine = data.lines.find(l => l.id === 'exalted');
        const chLine = data.lines.find(l => l.id === 'chaos');
        
        rates.d2e = 1 / exLine.primaryValue; // How many Ex per Div
        rates.d2c = 1 / chLine.primaryValue; // How many Chaos per Div
        rates.c2e = rates.d2e / rates.d2c;   // How many Ex per Chaos

        document.getElementById('rate-div-ex').innerText = rates.d2e.toFixed(2);
        document.getElementById('rate-div-ch').innerText = rates.d2c.toFixed(2);

        // 2. Build Table
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        targetItems.forEach(slug => {
            const line = data.lines.find(l => l.id === slug);
            const meta = data.items.find(i => i.detailsId === (slug === 'scrap' ? 'armourers-scrap' : slug));
            if (!line || !meta) return;

            // Direct Costs from API
            const costInDiv = line.primaryValue;
            
            // maxVolume info
            const altCurr = line.maxVolumeCurrency; // e.g., 'exalted'
            const altRate = line.maxVolumeRate;     // items per 1 alt currency
            const costInAlt = 1 / altRate;

            // Normalize EVERYTHING to Exalts for comparison
            const viaDiv = costInDiv * rates.d2e;
            const viaChaos = (altCurr === 'chaos') ? costInAlt : (costInDiv * rates.d2e); // simplify if chaos isn't primary alt
            const viaEx = (altCurr === 'exalted') ? costInAlt : (costInDiv * rates.d2e);

            // Determine best path
            const costs = [
                { name: 'Divine', val: viaDiv, tag: 'tag-div' },
                { name: 'Chaos', val: viaChaos, tag: 'tag-ch' },
                { name: 'Exalted', val: viaEx, tag: 'tag-ex' }
            ];
            const best = costs.reduce((prev, curr) => (prev.val < curr.val) ? prev : curr);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${meta.name}</strong></td>
                <td class="val-col ${best.name === 'Divine' ? 'highlight' : 'strike'}">${viaDiv.toFixed(3)}</td>
                <td class="val-col ${best.name === 'Chaos' ? 'highlight' : 'strike'}">${viaChaos.toFixed(3)}</td>
                <td class="val-col ${best.name === 'Exalted' ? 'highlight' : 'strike'}">${viaEx.toFixed(3)}</td>
                <td class="val-col"><span class="optimal-tag ${best.tag}">${best.name}</span></td>
            `;
            tbody.appendChild(row);
        });

        status.innerText = "UPDATED: " + new Date().toLocaleTimeString();
    } catch (e) {
        status.innerText = "Sync failed. Check browser console.";
        console.error(e);
    }
}

window.onload = fetchRates;
</script>

</body>
</html>