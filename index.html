<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaal Arbitrage Dashboard</title>
    <style>
        :root { --gold: #e1ad5f; --bg: #0c0c0c; --card: #161616; --border: #2a2a2a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #d1d1d1; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.6); margin-bottom: 15px; }
        h2 { color: var(--gold); text-align: center; margin-top: 0; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Rates Grid */
        .rates-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .rate-box { background: #222; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #333; }
        .rate-box small { display: block; color: #888; font-size: 0.7rem; margin-bottom: 4px; }
        .rate-box span { font-weight: bold; color: #fff; font-family: monospace; }

        /* Items List */
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #222; }
        .item-row:last-child { border-bottom: none; }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; font-size: 0.9rem; color: #eee; }
        .optimal-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; margin-left: 5px; text-transform: uppercase; }
        .tag-div { background: #4a3a1a; color: #ffcc66; }
        .tag-ex { background: #1a2e4a; color: #66ccff; }
        
        .price-details { text-align: right; font-size: 0.8rem; font-family: monospace; }
        .path-label { color: #666; font-size: 0.7rem; }
        .path-val { color: #aaa; }
        .best-val { color: var(--gold); font-weight: bold; }

        .btn-sync { width: 100%; padding: 12px; background: var(--gold); border: none; border-radius: 6px; color: #000; font-weight: 800; cursor: pointer; margin-bottom: 15px; }
        .status { font-size: 0.65rem; text-align: center; color: #555; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn-sync" onclick="fetchRates()">SYNC FATE OF THE VAAL</button>
    <div id="status" class="status">Waiting for sync...</div>

    <div class="card">
        <h2>Market Benchmarks</h2>
        <div class="rates-grid">
            <div class="rate-box"><small>DIV : EX</small><span id="rate-div-ex">---</span></div>
            <div class="rate-box"><small>DIV : CHAOS</small><span id="rate-div-ch">---</span></div>
        </div>
    </div>

    <div class="card">
        <h2>Optimal Purchase Paths</h2>
        <div id="item-list">
            </div>
    </div>
</div>

<script>
const targetItems = ["perfect-exalted-orb", "perfect-orb-of-augmentation", "armourers-scrap"];
let globalRates = { divToEx: 0, divToChaos: 0 };

async function fetchRates() {
    const status = document.getElementById('status');
    const proxy = "https://corsproxy.io/?";
    const target = "https://poe.ninja/poe2/api/economy/exchange/current/overview?league=Fate+of+the+Vaal&type=Currency";
    
    try {
        const response = await fetch(proxy + encodeURIComponent(target));
        const data = await response.json();
        
        // 1. Get Base Benchmarks
        const exLine = data.lines.find(l => l.id === 'exalted');
        const chaosLine = data.lines.find(l => l.id === 'chaos');
        
        globalRates.divToEx = 1 / exLine.primaryValue;
        globalRates.divToChaos = 1 / chaosLine.primaryValue;

        document.getElementById('rate-div-ex').innerText = `1 : ${globalRates.divToEx.toFixed(1)}`;
        document.getElementById('rate-div-ch').innerText = `1 : ${globalRates.divToChaos.toFixed(1)}`;

        // 2. Process Specific Items
        const listContainer = document.getElementById('item-list');
        listContainer.innerHTML = '';

        targetItems.forEach(slug => {
            const itemData = data.lines.find(l => l.id === slug);
            const itemMeta = data.items.find(i => i.detailsId === slug);
            if (!itemData || !itemMeta) return;

            // Math Logic:
            // Path A: Buy with Divines (direct primaryValue)
            // Path B: Buy with the 'maxVolumeCurrency' (usually Exalt or Chaos)
            const divCost = itemData.primaryValue; // Cost in fractions of a Divine
            const altCurrency = itemData.maxVolumeCurrency; // e.g. "exalted"
            const altRate = itemData.maxVolumeRate; // e.g. 5.5 (items per 1 Exalt)
            
            // Calculate which is better by converting Divine cost to the alt currency
            // If buying with Exalts: 1 Divine = 299 Ex. Item costs 0.1 Div. 
            // Buying with Div = 0.1 Div. Buying with Ex = (0.1 * 299) = 29.9 Ex.
            const altEquivalentOfDiv = divCost * (altCurrency === 'exalted' ? globalRates.divToEx : globalRates.divToChaos);
            const directAltCost = 1 / altRate; // Because Rate is items-per-currency
            
            const isAltBetter = directAltCost < altEquivalentOfDiv;
            const bestPath = isAltBetter ? altCurrency : 'divine';

            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
                <div class="item-info">
                    <div class="item-name">
                        ${itemMeta.name}
                        <span class="optimal-tag ${bestPath === 'divine' ? 'tag-div' : 'tag-ex'}">
                            Use ${bestPath === 'exalted' ? 'Exalts' : bestPath}
                        </span>
                    </div>
                </div>
                <div class="price-details">
                    <div><span class="path-label">Div:</span> <span class="${bestPath === 'divine' ? 'best-val' : 'path-val'}">${divCost.toFixed(4)}</span></div>
                    <div><span class="path-label">${altCurrency.substring(0,2)}:</span> <span class="${bestPath !== 'divine' ? 'best-val' : 'path-val'}">${directAltCost.toFixed(2)}</span></div>
                </div>
            `;
            listContainer.appendChild(row);
        });

        status.innerText = "LAST SYNC: " + new Date().toLocaleTimeString();
    } catch (e) {
        status.innerText = "Error syncing data.";
        console.error(e);
    }
}

window.onload = fetchRates;
</script>
</body>
</html>